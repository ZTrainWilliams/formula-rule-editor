import{t as ie,_ as ne,o as I,c as z,f as g,g as ce,v as re,h as ue,n as le,i as de,d as pe,j as v,k as X,l as Q,b as R,m as K,w as d,a as p,e as B,p as j,q as Z,F as Y,E as fe,s as me,u as he,x as _e,y as ve,z as ye}from"./index.fae441d1.js";var ge=0;function Ce(e){var r=++ge;return ie(e)+r}const be=["advlist indent2em anchor autolink code codesample colorpicker colorpicker contextmenu directionality emoticons fullscreen hr image imagetools insertdatetime link lists media nonbreaking noneditable pagebreak paste preview print save searchreplace spellchecker tabfocus table template textcolor textpattern visualblocks visualchars wordcount"],Ee=["searchreplace forecolor backcolor bold italic underline strikethrough alignleft aligncenter alignright outdent indent undo redo subscript superscript","fontsizeselect indent2em hr bullist numlist link image charmap anchor pagebreak code codesample blockquote removeformat fullscreen"];let W=[];function xe(){return window.tinymce}const we=(e,r)=>{const m=document.getElementById(e),i=r||function(){};if(!m){const s=document.createElement("script");s.src=e,s.id=e,document.body.appendChild(s),W.push(i),("onload"in s?k:A)(s)}m&&i&&(xe()?i(null,m):W.push(i));function k(s){s.onload=function(){this.onerror=null,this.onload=null;for(const a of W)a(null,s);W=null},s.onerror=function(){this.onerror=null,this.onload=null,i(new Error(`Failed to load ${e}`),s)}}function A(s){s.onreadystatechange=function(){if(!(this.readyState!=="complete"&&this.readyState!=="loaded")){this.onreadystatechange=null;for(const a of W)a(null,s);W=null}}}},Se={name:"Tinymce",props:{id:{type:String,default(){return`vue-tinymce-${+new Date}${(Math.random()*1e3).toFixed(0)}`}},tinymceCDN:{type:String,default:"https://public-web-res-1312176471.cos.ap-guangzhou.myqcloud.com/tinymce-5.10.0/tinymce.min.js"},disabled:{type:Boolean,default:!1},modelValue:{type:String,default:""},toolbar:{type:Array,required:!1,default(){return[]}},fontsizes:{type:String,default:"11px 12px 14px 16px 18px 20px 24px 36px 48px"},menubar:{type:String,default:"file edit insert view format table my1"},height:{type:[Number,String],required:!1,default:360},width:{type:[Number,String],required:!1,default:"auto"},config:{type:Object}},data(){return{hasChange:!1,hasInit:!1,tinymceId:this.id,fullscreen:!1,languageTypeList:{en:"en",zh:"zh_CN",es:"es_MX",ja:"ja"}}},computed:{containerWidth(){const e=this.width;return/^[\d]+(\.[\d]+)?$/.test(e)?`${e}px`:e}},watch:{modelValue(e){!this.hasChange&&this.hasInit&&this.$nextTick(()=>window.tinymce.get(this.tinymceId).setContent(e||""))},disabled(e){window.tinymce&&window.tinymce.get(this.tinymceId)&&window.tinymce.get(this.tinymceId).mode.set(e?"readonly":"design")}},mounted(){this.init()},activated(){window.tinymce&&this.initTinymce()},deactivated(){this.destroyTinymce()},unmounted(){this.destroyTinymce()},methods:{init(){we(this.tinymceCDN,e=>{if(this.$emit("loadTinymce",e),e){this.$message.error(e.message);return}this.initTinymce()})},initTinymce(){const e=this;window.tinymce.init({selector:`#${this.tinymceId}`,language:this.languageTypeList.zh,height:this.height,body_class:"panel-body ",object_resizing:!1,toolbar:this.toolbar.length>0?this.toolbar:Ee,menubar:this.menubar,fontsize_formats:this.fontsizes,plugins:be,readonly:this.disabled,end_container_on_empty_block:!0,powerpaste_word_import:"clean",code_dialog_height:450,code_dialog_width:1e3,advlist_bullet_styles:"square",advlist_number_styles:"default",imagetools_cors_hosts:["www.tinymce.com","codepen.io"],default_link_target:"_blank",link_title:!1,nonbreaking_force_tab:!0,init_instance_callback:r=>{this.$emit("initInstanceCallback",r),e.modelValue&&r.setContent(e.modelValue),e.hasInit=!0,r.on("NodeChange Change KeyUp SetContent",()=>{this.hasChange=!0,this.$emit("update:modelValue",r.getContent())})},setup(r){r.on("FullscreenStateChanged",m=>{e.fullscreen=m.state})},convert_urls:!1,...this.config})},destroyTinymce(){const e=window.tinymce.get(this.tinymceId);this.fullscreen&&e.execCommand("mceFullScreen"),e&&e.destroy()},setContent(e){window.tinymce.get(this.tinymceId).setContent(e)},getContent(){window.tinymce.get(this.tinymceId).getContent()}}},ke=["id"],Ie={class:"editor-custom-menu-right"};function Le(e,r,m,i,k,A){return I(),z("div",{class:le(["tinymce-container",{fullscreen:k.fullscreen,"tinymce-container-disabled":m.disabled}]),style:de({width:A.containerWidth})},[g("textarea",{id:k.tinymceId,class:"tinymce-textarea"},null,8,ke),ce(g("div",Ie,[ue(e.$slots,"menu-right",{},void 0,!0)],512),[[re,!m.disabled]])],6)}var Ne=ne(Se,[["render",Le],["__scopeId","data-v-39476db6"]]);const Te=pe({components:{tinymce:Ne},props:{modelValue:{type:String,defualt:""},id:{type:String,default:"tinymce-formula"},operatorList:{type:Array,default:()=>[]},functionList:{type:Array,default:()=>[]},color:{type:String,default:"#1C88E5"}},setup(e,{emit:r}){const m=v(null),i=X(()=>Ce(e.id)),k=v(""),A=v({toolbar:[],plugins:["autoresize"],menubar:[],statusbar:!1,autoresize_bottom_margin:20,autoresize_min_height:100,autoresize_max_height:500,content_style:`p {font-size: 14px} .mention-field{color: ${e.color}}`});let s=!1;const a=(n,l=0)=>{const f=document.createRange();return f.setStart(n,l),f.setEnd(n,l),f},V=()=>{const n=window.tinyMCE.editors[i.value];n.setContent(k.value,{noSelection:!0}),Q(()=>{requestAnimationFrame(()=>{const l=n.selection.getEnd();n.selection.setRng(a(l,l.childNodes.length)),n.focus()})}),s=!0},h=n=>{var u;const l=(u=window.tinyMCE)==null?void 0:u.editors[i.value];if(!l)return;const f=l.getBody(),N=f.textContent;if(e.modelValue===N)return;const y=f.childNodes,_=[],M=e.operatorList.map(U=>{var E;return`\\${(E=U.value)!=null?E:U}`}).join(""),F=new RegExp(`([${M}])`),b=new RegExp(`([${M}])`);y.forEach(U=>{U.childNodes.forEach(E=>{const P=E.nodeType===1&&(E==null?void 0:E.getAttribute)?E==null?void 0:E.getAttribute("class"):"",D=E.textContent;E.nodeType===3?D!==""&&_.push({type:"text",value:D}):P&&P.indexOf("mention-field")!==-1?D!==""&&_.push({type:"field",value:D}):P&&P.indexOf("mention-operator")!==-1?D.split(F).forEach(o=>{o!==""&&(b.test(o)?_.push({type:"operator",value:o}):_.push({type:"text",value:o}))}):_.push({type:"text",value:D})})}),r("changeHtmlContent",n),r("change",_),r("input:modelValue",N)},C=()=>{window.tinyMCE.editors[i.value].on("change",l=>{h(l)}),s||V()},T=({value:n,type:l,offset:f,offsetIdx:N})=>{const y=window.tinyMCE.editors[i.value];if(l==="operator")f?(y.insertContent(n),L(N)):y.insertContent(n);else if(l==="field")y.insertContent(`<span class="mention-${l}" contenteditable="false">${`#${n}#`}</span>`);else{if(Object.prototype.toString.call(n)==="[object Array]")for(let _=0;_<n.length;_++)y.insertContent(n[_]);else y.insertContent(n);f&&L(N)}C(),y.focus()},L=n=>{const l=window.tinyMCE.editors[i.value],f=l.selection.getRng(),y=f.startOffset-1;l.selection.setRng({startContainer:f.startContainer,startOffset:n!=null?n:y,endContainer:f.startContainer,endOffset:n!=null?n:y})},$=n=>{if(!n)return[];const l=`([${e.operatorList.map(b=>{var u;return`\\${(u=b.value)!=null?u:b}`}).join("|")}|${e.functionList.map(b=>`\\b${b.label}\\b`).join("|")}\\s])`,f=new RegExp(l),N=n.split(f),y=new RegExp(`[${e.operatorList.map(b=>{var u;return`\\${(u=b.value)!=null?u:b}`}).join("")}]`),_=[];let M=!1,F="";for(let b=0;b<N.length;b=b+1){const u=N[b];u===""||u===void 0||(u.startsWith("#")?(M=!0,F=u,u.endsWith("#")&&(_.push({type:"field",value:u}),M=!1,F="")):M?(F+=u,u.endsWith("#")&&(_.push({type:"field",value:F}),M=!1,F="")):y.test(u)?_.push({type:"text",value:u}):_.push({type:"text",value:u}))}return _},O=n=>n.map(l=>l.type==="field"?`<span class="mention-field" contenteditable="false">${l.value}</span>`:l.type==="operator"?`<span class="mention-operator">${l.value}</span>`:l.value).join("");return{ztTinymceRef:m,curId:i,content:k,config:A,contentChange:h,initInstanceCallback:C,insertContent:T,setContent:n=>{k.value=n;const l=$(n),f=O(l);k.value=f,Q(()=>{window.tinyMCE?V():s=!1})}}}});function $e(e,r,m,i,k,A){const s=R("tinymce");return I(),K(s,{id:e.curId,ref:"ztTinymceRef",modelValue:e.content,"onUpdate:modelValue":r[0]||(r[0]=a=>e.content=a),config:e.config,height:220,width:"100%",class:"tinymce-formula-main",onInitInstanceCallback:e.initInstanceCallback},null,8,["id","modelValue","config","onInitInstanceCallback"])}var Re=ne(Te,[["render",$e],["__scopeId","data-v-6bc0bbd4"]]);const oe=e=>(he("data-v-e090c052"),e=e(),_e(),e),Ae=oe(()=>g("h6",null,"\u5F15\u7528\u5B57\u6BB5",-1)),Ve=oe(()=>g("h6",null,"\u8FD0\u7B97\u7B26",-1)),Oe={class:"rule-row-content"},Me=oe(()=>g("h6",null,"\u5E38\u7528\u51FD\u6570",-1)),Fe={__name:"formula-dialog",props:{request:Object,title:{type:String,title:"\u7F16\u8F91\u516C\u5F0F\u89C4\u5219"}},emits:["onClose"],setup(e,{expose:r,emit:m}){const i=e,k=m,A=v(!1),s=v(!1),a=v({calcExpression:null,expressionContent:"",formulaContent:""}),V=v(),h=v(null),C=v(-1),T=v(!1),L=v(""),$=v({name:""}),O=v(null),ee=/^\s*$/,n=v([]),l=X(()=>{var t,o;return(o=(t=i.request)==null?void 0:t.operatorList)!=null?o:["+","-","*","/","(",")"]}),f=X(()=>{var t,o;return(o=(t=i.request)==null?void 0:t.functionList)!=null?o:[]}),N=X(()=>{const t=[];return n.value.forEach(o=>{o.variableList.forEach(x=>{t.push(x)})}),t}),y=X(()=>{if(L.value)return L.value;let t="\u516C\u5F0F\u672A\u68C0\u9A8C";return C.value===0?t="\u516C\u5F0F\u68C0\u9A8C\u4E0D\u901A\u8FC7":C.value===1&&(t="\u516C\u5F0F\u68C0\u9A8C\u901A\u8FC7"),t}),_=X(()=>{let t="info-color no-check";return C.value===0?t="error-color fail-check":C.value===1&&(t="success-color success-check"),t}),M=t=>{t.code!==$.value.code&&O.value.insertContent({value:t.name,type:"field"})},F=t=>{typeof t=="string"?O.value.insertContent({value:t,type:"text"}):O.value.insertContent({...t,type:"text"})},b=t=>{O.value.insertContent({...t,type:"function"})},u=t=>{let o="",x="";const w=[];console.log("contendEditChange",t),(t||[]).forEach(c=>{if(c.type==="field"){const te=c.value.replace(/#/g,""),H=N.value.find(J=>J.name===te);H?x+=H.code:x+=c.value,w.push({...c,value:H?H.code:c.value})}else x+=c.value,w.push(c);o+=c.value}),a.value={expressionContent:o,calcExpression:x.replace(/[\u200B-\u200D\uFEFF]/g,""),calcList:w},Q(()=>{C.value=-1,L.value="",V.value.validateField("calcExpression")})},U=()=>(T.value=!0,L.value="",new Promise((t,o)=>{if(ee.test(a.value.calcExpression)){o("\u8BF7\u8F93\u5165\u516C\u5F0F\u89C4\u5219"),T.value=!1;return}V.value.validate(x=>{var w;x?i.request.checkRule({...(w=i.request.extraParams)!=null?w:{},calcExpression:a.value.calcExpression,calcList:a.value.calcList,code:$.value.code,name:$.value.name,expressionContent:a.value.expressionContent}).then(c=>{console.log("res",c),c!=null&&c.success?(t(),C.value=1):(C.value=0,L.value=c.message,o(y.value)),T.value=!1}).catch(()=>{C.value=0,T.value=!1,o(y.value)}):(o("\u8BF7\u8F93\u5165\u516C\u5F0F\u89C4\u5219"),T.value=!1)})})),E=()=>{a.value={},s.value=!1},P=()=>{V.value.validate(t=>{t&&Q(()=>{U().then(()=>{k("change",{...a.value}),E()}).catch(o=>{console.log("errText",o),fe.error(o)})})})};return r({open:async t=>{$.value=t,await i.request.queryVariable($.value).then(o=>{n.value=o}),s.value=!0,a.value={expressionContent:t.expressionContent,calcExpression:t.calcExpression,calcList:t.calcList},h.value=t.variableType,Q(()=>{C.value=-1,L.value="",V.value.clearValidate();const o=[];t.calcList&&t.calcList.forEach(x=>{if(x.type==="field"){const w=N.value.find(c=>c.code===x.value);w?o.push({type:x.type,value:w.value}):o.push(x)}else o.push(x)}),O.value&&O.value.setContent(t.expressionContent)})}}),(t,o)=>{const x=R("el-form-item"),w=R("el-button"),c=R("el-row"),te=R("el-form"),H=R("el-divider"),J=R("el-col"),se=R("el-dialog");return I(),K(se,{modelValue:s.value,"onUpdate:modelValue":o[1]||(o[1]=S=>s.value=S),title:e.title,width:"780","close-on-click-modal":!1,onClose:E},{footer:d(()=>[p(c,{class:"dialog-footer",justify:"end"},{default:d(()=>[g("div",null,[p(w,{type:"primary",loading:A.value,onClick:P},{default:d(()=>[B(" \u786E\u5B9A ")]),_:1},8,["loading"]),p(w,{onClick:E},{default:d(()=>[B("\u53D6\u6D88")]),_:1})])]),_:1})]),default:d(()=>[p(c,{class:"rule-main"},{default:d(()=>[p(J,{span:16,class:"main-left"},{default:d(()=>[p(te,{ref_key:"formRef",ref:V,class:"rule-row",model:a.value},{default:d(()=>[g("h6",null,j($.value.name)+" =",1),p(x,{label:" ",prop:"calcExpression","label-width":0,rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u516C\u5F0F\u89C4\u5219"}]},{default:d(()=>[p(Re,{ref_key:"contendEditRef",ref:O,modelValue:a.value.expressionContent,"onUpdate:modelValue":o[0]||(o[0]=S=>a.value.expressionContent=S),operatorList:l.value,functionList:f.value,onChange:u},null,8,["modelValue","operatorList","functionList"])]),_:1}),p(c,null,{default:d(()=>[p(w,{loading:T.value,disabled:ee.test(a.value.calcExpression),onClick:U},{default:d(()=>[B(" \u6821\u9A8C\u516C\u5F0F ")]),_:1},8,["loading","disabled"]),g("span",{class:le([_.value,"check-tip-span"])},j(y.value),3)]),_:1})]),_:1},8,["model"]),p(H),p(c,{class:"rule-row"},{default:d(()=>[Ae,(I(!0),z(Y,null,Z(n.value,(S,G)=>(I(),z(Y,null,[!h.value||h.value.includes(S.type)?(I(),z("div",{key:G},[g("p",null,j(S.type),1),g("div",null,[(I(!0),z(Y,null,Z(S.variableList,(q,ae)=>(I(),K(w,{key:ae,disabled:q.code===$.value.code,class:"tag-span",onClick:He=>M(q)},{default:d(()=>[B(j(q.name),1)]),_:2},1032,["disabled","onClick"]))),128))])])):me("",!0)],64))),256))]),_:1})]),_:1}),p(J,{span:8},{default:d(()=>[p(c,{class:"rule-row"},{default:d(()=>[Ve,g("div",Oe,[(I(!0),z(Y,null,Z(l.value,(S,G)=>(I(),K(w,{key:G,class:"tag-span",onClick:q=>F(S)},{default:d(()=>{var q;return[B(j((q=S.value)!=null?q:S),1)]}),_:2},1032,["onClick"]))),128))])]),_:1}),p(c,{class:"rule-row"},{default:d(()=>[Me,(I(!0),z(Y,null,Z(f.value,(S,G)=>(I(),K(w,{key:G,class:"tag-span",onClick:q=>b(S)},{default:d(()=>[B(j(S==null?void 0:S.label),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])}}};var qe=ne(Fe,[["__scopeId","data-v-e090c052"]]);const ze={class:"index-page"},Be=g("h3",null,"\u6B22\u8FCE\u4F7F\u7528\u4E1A\u52A1\u89C4\u5219\u516C\u5F0F\u7F16\u8F91\u5668",-1),je=g("p",{style:{margin:"16px 0"}},"\u516C\u5F0F\u89C4\u5219:",-1),Ue={class:"content"},De=g("p",{style:{margin:"16px 0"}},"\u5B9E\u9645\u516C\u5F0F\u89C4\u5219:",-1),Pe={class:"content"},Xe={__name:"index",setup(e){const r=v([{type:"\u8425\u4E1A\u4F53\u7CFB",variableList:[{code:"MAIN_BUSINESS_INCOME",name:"\u4E3B\u8425\u4E1A\u52A1\u6536\u5165"},{code:"MATERIAL_SALES_INCOME",name:"\u6750\u6599\u9500\u552E\u6536\u5165"},{code:"OTHER_BUSINESS_INCOME",name:"\u5176\u4ED6\u4E1A\u52A1\u6536\u5165"},{code:"MAIN_BUSINESS_COST",name:"\u4E3B\u8425\u4E1A\u52A1\u6210\u672C"},{code:"BUSINESS_TAX_SURCHARGE",name:"\u8425\u4E1A\u7A0E\u91D1\u53CA\u9644\u52A0"},{code:"OPERATING_EXPENSES",name:"\u8425\u4E1A\u8D39\u7528"}]},{type:"\u8D44\u4EA7\u8FD0\u8425",variableList:[{code:"SELLING_EXPENSES",name:"\u9500\u552E\u8D39\u7528"},{code:"FINANCIAL_EXPENSES",name:"\u8D22\u52A1\u8D39\u7528"},{code:"INVESTMENT_INCOME",name:"\u6295\u8D44\u6536\u76CA"},{code:"ASSET_IMPAIRMENT_LOSS",name:"\u8D44\u4EA7\u51CF\u503C\u635F\u5931"}]},{type:"\u5176\u4ED6",variableList:[{code:"OTHER_BUSINESS_COST",name:"\u5176\u4ED6\u4E1A\u52A1\u6210\u672C"}]},{type:"\u7CFB\u6570",variableList:[{code:"PERFORMANCE_COEFFICIENT",name:"\u7EE9\u6548\u7CFB\u6570"},{code:"ANNUAL",name:"\u5E74\u5EA6"},{code:"QUARTERLY",name:"\u5B63\u5EA6"},{code:"MONTHLY",name:"\u6708\u5EA6"}]}]),m=v({expressionContent:"#\u4E3B\u8425\u4E1A\u52A1\u6536\u5165#+#\u6750\u6599\u9500\u552E\u6536\u5165#",calcExpression:"MAIN_BUSINESS_INCOME+MATERIAL_SALES_INCOME"}),i=v(null),k=v([{label:"AND",value:"AND",offsetIdx:0},{label:"OR",value:"OR",offsetIdx:0},{label:"IF",value:["IF(",")"]},{label:"HALT",value:['HALT("','", , )']}]),A=h=>new Promise((C,T)=>{["+","-","*","/"].includes(h.calcList[h.calcList.length-1].value)?C({success:!1,message:"\u516C\u5F0F\u6821\u9A8C\u4E0D\u901A\u8FC7"}):C({success:!0,message:"\u516C\u5F0F\u6821\u9A8C\u901A\u8FC7"})}),s=()=>new Promise(h=>{h(r.value)}),a=()=>{const h={name:"\u8425\u4E1A\u5229\u6DA6",code:""};i.value.open({...h,...m.value})},V=h=>{h&&(m.value.expressionContent=h.expressionContent,m.value.calcExpression=h.calcExpression)};return(h,C)=>{const T=R("el-icon"),L=R("el-button"),$=R("el-row");return I(),z("div",ze,[Be,g("div",null,[je,g("div",Ue,[B(j(m.value.expressionContent)+" ",1),p(L,{type:"",link:"",title:"\u7F16\u8F91",onClick:a},{default:d(()=>[p(T,null,{default:d(()=>[p(ve(ye))]),_:1})]),_:1})]),De,g("div",Pe,j(m.value.calcExpression),1),p(L,{type:"primary",onClick:a},{default:d(()=>[B("\u7F16\u8F91\u89C4\u5219")]),_:1})]),p($),p(qe,{ref_key:"formulaRulesRef",ref:i,title:"\u7F16\u8F91\u516C\u5F0F\u89C4\u5219",request:{queryVariable:s,checkRule:A,functionList:k.value},onChange:V},null,8,["request"])])}}};export{Xe as default};
